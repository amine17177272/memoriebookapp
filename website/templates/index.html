{% extends "base.html" %}

{% block title %}
Home
{% endblock %}

{% block content %}
<div class="container mt-4">
    <nav class='menu'>
        <ul>
            <li><a href="{{ url_for('views.home') }}">Return to home page</a></li>
            <li><a href="{{ url_for('views.search') }}" class="btn btn-secondary">Search Users</a></li>
        </ul>
    </nav>
    <h1>Welcome, {{ user.user_name }}</h1>

    <form id="postForm" method="POST">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="form-group">
            <textarea id="postContent" name="content" class="form-control" rows="3"
                placeholder="What's on your mind?"></textarea>
        </div>
        <button type="submit" class="btn btn-primary">Post</button>
    </form>

    <hr>

    <div class="posts">
        {% for post in posts %}
        {% if post.user_id == user.id %}
        <div class="card my-3" id="post-{{ post.id }}">
            <div class="card-body d-flex justify-content-between align-items-center">
                <p>{{ post.data }}</p>
                <footer class="blockquote-footer">
                    Posted by {{ post.user.user_name }} on {{ post.date.strftime('%Y-%m-%d') }}
                </footer>
                <p>Likes: <span class="likes-count">{{ post.likes|length }}</span></p>
                <button class="like-btn" data-post-id="{{ post.id }}">
                    {% if post.id in liked_posts %}Unlike{% else %}Like{% endif %}
                </button>
                <button class="delete-btn btn btn-danger btn-sm" data-post-id="{{ post.id }}">Delete</button>
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        document.querySelectorAll('.like-btn').forEach(button => {
            button.addEventListener('click', function () {
                const postId = this.getAttribute('data-post-id');

                fetch(`/post/${postId}/like`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token() }}'
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'liked') {
                            this.textContent = 'Unlike';
                        } else {
                            this.textContent = 'Like';
                        }
                        this.closest('.card-body').querySelector('.likes-count').textContent = data.like_count;
                    });
            });
        });
    });
    document.addEventListener('DOMContentLoaded', function () {
        const postForm = document.getElementById('postForm');
        const csrfToken = document.querySelector('input[name="csrf_token"]').value;

        postForm.addEventListener('submit', function (event) {
            event.preventDefault(); // Prevent the default form submission

            const postContent = document.getElementById('postContent').value;

            fetch('{{ url_for('views.add_post') }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ content: postContent })
            })
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    } else {
                        throw new Error('Network response was not ok.');
                    }
                })
                .then(data => {
                    console.log(data);
                    location.reload(); // Reload the page to see the new post
                })
                .catch(error => console.error('Error:', error));
        });

        document.querySelectorAll('.delete-btn').forEach(button => {
            button.addEventListener('click', function () {
                const postId = this.getAttribute('data-post-id');

                fetch(`/post/${postId}/delete`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    }
                })
                    .then(response => {
                        if (response.ok) {
                            return response.json();
                        } else {
                            throw new Error('Network response was not ok.');
                        }
                    })
                    .then(data => {
                        console.log(data);
                        document.getElementById(`post-${postId}`).remove();
                    })
                    .catch(error => console.error('Error:', error));
            });
        });
    });
</script>
{% endblock %}